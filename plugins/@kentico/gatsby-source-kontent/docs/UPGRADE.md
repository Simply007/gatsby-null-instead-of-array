# Upgrade guide

## From `3.x.x` to `4.x.x`

This upgrade is mainly caused by upgrading [Kentico Kontent Javascript Delivery SDK](https://github.com/Kentico/kontent-delivery-sdk-js), adding new features, and performance tuning.

### Language fallbacks

Gatsby source plugin is now including GraphQL nodes by the language fallbacks configuration. As a part of that, there is a new `prefered_language` property allowing to distinguish whether the fallback has been used or not.If the fallback is used `prefered language` is set to the desired language codename, but `system.language` value is using the actual culture that has been used (the fallback one). If the values are same, fallback is was not used.

### Configurable logging

There is a new plugin configuration property `enableLogging` which allows to turn on source plugin logging. Logging per every node generation was removed completely due to performance.

### Configurable content property

There is a new plugin configuration property `includeRawContent` which allows to include `internal.content` property as apart of the Kontent node. Property is not generated by default, because it was causing memory spikes for bigger projects (1000+ Kontent items).

### Custom element support

Custom element is now supported including [custom element models definition](https://github.com/Kentico/kontent-delivery-sdk-js/blob/v8.0.0/DOCS.md#using-custom-models-for-custom-elements). SO besides of the raw value property `value` it is possible to parse it and include it in the GraphQL model.

### Query names prefix changed

Query names prefixed has changed from `KenticoCloud*` to `Kontent*` - i.e. `KenticoCloudTypeArticle`->`KontentTypeArticle`, `KenticoCloudItemPost`->`KontentItemPost`.

### Delivery configuration

When configuring the Kentico Kontent Source plugin one of the properties to set is `deliveryClientConfig`. It is respecting the [`IDeliveryClientConfig`](https://github.com/Kentico/kontent-delivery-sdk-js/blob/master/UPGRADE.md#ideliveryclientconfig) interface from Kentico Kontent Delivery SDK.

#### Example

```javascript
module.exports = {
  ...
  plugins: [
    ...
    {
      resolve: `@kentico/gatsby-source-kontent`,
      options: {
        deliveryClientConfig: { // Configuration object
          projectId: `XXX`,
          typeResolvers: [],
          previewApiKey: `YYY`,
          secureApiKey: `ZZZ`,
          globalQueryConfig:  {
            ...
            usePreviewMode: true, // uses preview mode
            useSecuredMode: false, // disabled secured mode
            ...
          },
        },
        languageCodenames: [ // example configuration
          `en-US`, // default language
          `es-ES`,
        ]
      }
    }
    ...
  ]
  ...
}
```

### Elements structure unification

Basic Kontent Item Node elements types (text, name, date & time, multiple choice) [has element property called `value`](https://github.com/Kentico/kontent-delivery-sdk-js/blob/v8.0.0/UPGRADE.md#removal-of-type-specific-element-properties) not an element specific property.

Image assets now contains [information about its resolution](https://docs.kontent.ai/reference/api-changelog#a-image-resolution-in-delivery-api).

Linked items are not directly under the element codename (`linked_items_type` in example). There are new fields `name`, `type` and `itemCodenames` containing array of linked items codenames.

#### Elements structure example

```gql
{
  allKontentBasicElementExample {
    nodes {
      elements {
        text_type {
          name
          type
          value
        }
        number_type {
          name
          type
          value
        }
        date_of_birth {
          name
          type
          value
        }
        multiple_choice_type {
          name
          type
          value {
            codename
            name
          }
        }
        asset_type {
          name
          type
          value {
            name
            description
            size
            type
            url
            width
            height
          }
        }
        custom_element_type {
          name
          type
          value
        }
        linked_items_type {
          name
          type
          itemCodenames // array of the codenames
          linked_items { // Gatsby Graphql node relationships
            ... on Node {
              ... on KontentSubItemExample {
                elements {
                  text_type {
                    name
                    type
                    value
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
```

### Rich text element structure

Rich text elements internal structure was extended. The main difference is that `resolvedHtml` is now transfered `resolvedData.html`.

```gql
{
  allKontentRichTextExample {
    nodes {
      elements {
        rich_text_type {
          name
          type
          value
          linkedItemCodenames // array of the codenames
          linked_items {
            ... on Nodes {
              ... on KontentSubItemExample {
                elements {
                  text_type {
                    name
                    type
                    value
                  }
                }
              }
            }
          }
          images {
            description
            height
            imageId
            url
            width
          }
          links {
            codename
            linkId
            type
            urlSlug
          }
          resolvedData {
            html
            linkedItemCodenames
            componentCodenames
          }
        }
      }
    }
  }
}
```

### Schema definition API

Thanks to [#80](https://github.com/Kentico/gatsby-source-kontent/pull/80) it is possible remove the [fully filled dummy content items](https://github.com/Kentico/gatsby-source-kontent/issues/59#issuecomment-496412677) from Kentico Kontent to provide Gatsby inference engine information about content structure.

For linked items in linked items element nor for rich text element encapsulation into the `... on Node` [GraphQL inline fragment](https://graphql.org/learn/queries/#inline-fragments) is not required any more ([#82](https://github.com/Kentico/gatsby-source-kontent/pull/82)).

```gql
{
  allKontentItemProjectReference {
    nodes {
      elements {
        related_project_references {
          linked_items {
            ... on Node { // NOT REQUIRED
              __typename
              ... on KontentItemBlogpostReference {
                elements {
                  title {
                    value
                  }
                }
              }
              ... on KontentItemProjectReference {
                elements {
                  project_name {
                    value
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
```

#### All Item query

As a part of that adjustment there are two queries (`allKontentItem` and `kontentItem`) allows to load content items from unified endpoint regardless of type

```gql
  query {
    allKontentItem {
      nodes {
        system {
          codename
          name
        }
      }
    }
  }
```
